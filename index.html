<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SSL 证书过期监测 配置</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      background-color: #f9fafb;
      color: #333;
      line-height: 1.6;
      padding: 40px 20px;
    }

    .container {
      max-width: 1200px;
      margin: auto;
      text-align: center;
    }

    textarea {
      width: 100%;
      height: 220px;
      margin: 0 auto 20px auto;
      display: block;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 10px;
      resize: vertical;
      font-family: monospace;
      box-sizing: border-box;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      background-color: #fff;
    }

    th, td {
      border: 1px solid #e0e0e0;
      padding: 8px 10px;
      text-align: left;
    }

    th {
      background-color: #f5f5f5;
      font-weight: 600;
    }

    tbody tr:nth-child(odd) {
      background-color: #fafafa;
    }

    tbody tr:hover {
      background-color: #f0f8ff;
    }

    button.btn {
      padding: 10px 16px;
      margin-bottom: 20px;
      cursor: pointer;
      background-color: #007bff;
      border: none;
      color: #fff;
      font-size: 16px;
      border-radius: 4px;
      transition: background-color 0.2s ease-in-out;
    }

    button.btn:hover {
      background-color: #0056b3;
    }

    #progress {
      margin-bottom: 10px;
      font-weight: bold;
    }
    .progress-container {
      width: 100%;
      background-color: #e5e5e5;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 10px;
    }
    .progress-bar {
      width: 0;
      height: 8px;
      background-color: #007bff;
      transition: width 0.3s ease;
    }
    .loading:after {
      content: "";
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid #ccc;
      border-top-color: #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 5px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

  </style>
</head>

<body>
  <div class="container">
    <button type="button" class="btn" id="save">保存</button>
      <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
      <p id="progressText"></p>
    <textarea id="config" placeholder="每行格式：域名[:端口]|手机号1,手机号2"></textarea>
    <div>
      <table>
        <thead>
          <tr>
            <th>域名</th>
            <th>起效时间</th>
            <th>到期时间</th>
            <th>到期天数</th>
            <th>通知手机号</th>
          </tr>
        </thead>
        <tbody id="tbody"><tr><td colspan="5">加载中...</td></tr></tbody>
      </table>
    </div>
  </div>

  <script>
    Date.prototype.Format = function (fmt) {
      var o = {
        "M+": this.getMonth() + 1,                 //月份
        "d+": this.getDate(),                    //日
        "h+": this.getHours() % 12 == 0 ? 12 : this.getHours() % 12, //小时
        "H+": this.getHours(), //小时
        "m+": this.getMinutes(),                 //分
        "s+": this.getSeconds(),                 //秒
        "q+": Math.floor((this.getMonth() + 3) / 3), //季度
        "S": this.getMilliseconds()             //毫秒
      };
      if (/(y+)/.test(fmt))
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      for (var k in o)
        if (new RegExp("(" + k + ")").test(fmt))
          fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
      return fmt;
    }

    const checkerSSLCertificate = (host, port = 443) => {
      return new Promise((resolve, reject) => {
        if (!port || isNaN(parseFloat(port)) || !isFinite(port)) {
          reject(new Error('Invalid host or port'))
        }

        fetch(`/api/checkerSSLCertificate?host=${host}&port=${port}`, {
          method: "GET",
          // mode: 'cors',
        }).then(response => response.json()).then(json => {
          resolve(json)
        }).catch(error => reject(error))
      })
    }


    const getConfig = () => {
      fetch('/api/config', {
        method: 'GET',
      }).then(response => response.json()).then(json => {
        if (json.code !== 1) {
          alert('获取配置数据失败:' + json.msg)
          return
        }

        document.getElementById('config').value = json.result
        const lines = json.result.split('\n')
        const progressText = document.getElementById('progressText')
        const progressBar = document.getElementById('progressBar')
        const tbody = document.getElementById('tbody')
        tbody.innerHTML = ''
        let total = 0
        let finished = 0
        const domains = []

        for (const lineRaw of lines) {
          let line = lineRaw
          if (line.trim().includes('//')) {
            line = line.split('//')[0]
          }
          if (!line.trim()) continue

          const [hostStr, phones] = line.split('|')
          if (!hostStr || !hostStr.trim()) continue

          const phoneList = phones && phones.split ? phones.split(',').map(p => p.trim()) : []
          const [host, port] = hostStr.trim().split(':')
          total++
          const rowId = 'row-' + total
          const tr = document.createElement('tr')
          tr.id = rowId
          tr.innerHTML = `
            <td>${host}${port && port !== '443' ? ':' + port : ''}</td>
            <td colspan="3"><span class="loading">检测中</span></td>
            <td>${phoneList.join(', ')}</td>
          `
          tbody.appendChild(tr)
          domains.push({ host, port, phoneList, rowId })
        }

        if (total === 0) {
          progressText.textContent = '未检测到域名'
          return
        }

        progressText.textContent = `检测进度：0/${total}`

        const updateProgress = () => {
          finished++
          progressText.textContent = `检测进度：${finished}/${total}`
          progressBar.style.width = (finished / total * 100) + '%'
          if (finished === total) {
            progressText.textContent = '检测完成'
          }
        }

        domains.forEach(({ host, port, phoneList, rowId }) => {
          checkerSSLCertificate(host, port).then(({ code, msg, result }) => {
            const tr = document.getElementById(rowId)
            if (code === 1) {
              const { valid_from, valid_to, days } = result
              tr.innerHTML = `
                <td>${host}${port && port !== '443' ? ':' + port : ''}</td>
                <td>${new Date(valid_from).Format('yyyy-MM-dd HH:mm:ss')}</td>
                <td>${new Date(valid_to).Format('yyyy-MM-dd HH:mm:ss')}</td>
                <td>${days}</td>
                <td>${phoneList.join(', ')}</td>
              `
            } else {
              tr.innerHTML = `
                <td>${host}${port && port !== '443' ? ':' + port : ''}</td>
                <td colspan="2">请求失败：${msg}</td>
                <td> - </td>
                <td>${phoneList.join(', ')}</td>
              `
            }
          }).catch(err => {
            const tr = document.getElementById(rowId)
            tr.innerHTML = `
              <td>${host}${port && port !== '443' ? ':' + port : ''}</td>
              <td colspan="2">请求失败：网络错误</td>
              <td> - </td>
              <td>${phoneList.join(', ')}</td>
            `
          }).finally(updateProgress)
        })
      })
    }
    const setConfig = () => {
      fetch("/api/config", {
        method: "POST",
        // mode: 'cors',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          'data': document.getElementById('config').value
        })
      }).then(response => response.json()).then(json => {
        if (json.code === 1) {
          alert('保存成功')
          window.location.reload()
        } else alert('保存失败:', json.msg)
      })
    }

    window.onload = function () {
      document.getElementById('save').onclick = setConfig
      getConfig()
    }
  </script>
</body>

</html>
